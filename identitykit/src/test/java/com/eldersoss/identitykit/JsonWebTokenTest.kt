package com.eldersoss.identitykit

import com.eldersoss.identitykit.jwt.JWTVerifier
import com.eldersoss.identitykit.jwt.JsonWebToken
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config

@RunWith(RobolectricTestRunner::class)
@Config(constants = BuildConfig::class)
class JsonWebTokenTest {

    @Test
    fun initTestRS256modulusExponent() {
        val token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik5EZ3dNalExUmpORk4wTkVSRE5FT1RKRk1qSkNRa1U0UmpNNU16VkdSVFJHTURRM01qazBOQSJ9.eyJuaWNrbmFtZSI6ImthbGluLnZlbmtvdiIsIm5hbWUiOiJrYWxpbi52ZW5rb3ZAZWxkZXJzb3NzLmNvbSIsInBpY3R1cmUiOiJodHRwczovL3MuZ3JhdmF0YXIuY29tL2F2YXRhci9iZTI5OWMwODBlNzEwMDY0MWIwY2FhYmMzM2QyMThjND9zPTQ4MCZyPXBnJmQ9aHR0cHMlM0ElMkYlMkZjZG4uYXV0aDAuY29tJTJGYXZhdGFycyUyRmthLnBuZyIsInVwZGF0ZWRfYXQiOiIyMDE5LTA4LTI4VDEwOjE3OjQyLjQ1NFoiLCJlbWFpbCI6ImthbGluLnZlbmtvdkBlbGRlcnNvc3MuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImlzcyI6Imh0dHBzOi8vc3Ryb3dyLWRldmVsb3BtZW50LmV1LmF1dGgwLmNvbS8iLCJzdWIiOiJhdXRoMHw1YzU0NjI1ZDc1ZWIwMjA5NmZkYzM3MzciLCJhdWQiOiJrSVFNNm01dnRQOG0xc2ZwWDdaTTdaYXZLZzJKeTQ1YyIsImlhdCI6MTU2Njk4NzQ2MiwiZXhwIjoxNTY3MDIzNDYyfQ.gNQRp7DhhkmhqCV1QF25i8k4CXCHY8zgjbK-j9YJVuOkniZMbz54V2jR6JCW26wEvd2NkOqINN-mztCao8E2915gjhLjHUeeZBXs9t6VE3_Fs5rd0CfoDLeXlicJAmIb86LZVSZRznOx7NrlEcd9PQP3IdlqYfZiI9blR5GqJRrauDou2NA8qm72Wtth8zoljGl2XSh65bhU0RVF--jYfzP4c3czF4Hvx1iNYDRJENUDJelQVHf_CqJm1_e93Rktm0v0YVUbFrzsJPqL06dHSUO8Q5dZEgql3ArjLq88dcyLPMewbP_6sZhIBHBF6cNndVvi5KrVP_npMf0vu6JhbQ"
        val jwt = JsonWebToken(token)

        val verifier = JWTVerifier()
        val modulus = "0PMn0dVPGCTZvzYl2uuB-UrtA3Cat0p5nsJVEV9YDjp0XH7f75X1l9Mtjynnbq0dhZH3DywwTFHGqcnY9EoMFFY-oo9LjtsO9Kgb-mmLG7QfqA0i2houjc1pK-aFypbiJA56yrPp9K24s2YBGOBNEX3KG4XH3pu8EeRyfpD8OyXP1zmRE21AhL26sHV7GmXNgWE1vtxarxjai8kisxKje7B81COqQcfExxAmXCG3unETz8szEceSRfNHB35mc5VKq8mgIjmZDGTsrcReRclwpJVUinKu1bEjyv4C3ekebTZCQgXqAUbCSMWffNCbj1xht_IimZGyGSSHEW_muy2L-Q"
        val exponent = "AQAB"
        verifier.jwksFromModulusAndExponent(modulus, exponent)

        assert(verifier.verify(jwt))
    }

    @Test
    fun initTestRS256x509() {
        val token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik5EZ3dNalExUmpORk4wTkVSRE5FT1RKRk1qSkNRa1U0UmpNNU16VkdSVFJHTURRM01qazBOQSJ9.eyJuaWNrbmFtZSI6ImthbGluLnZlbmtvdiIsIm5hbWUiOiJrYWxpbi52ZW5rb3ZAZWxkZXJzb3NzLmNvbSIsInBpY3R1cmUiOiJodHRwczovL3MuZ3JhdmF0YXIuY29tL2F2YXRhci9iZTI5OWMwODBlNzEwMDY0MWIwY2FhYmMzM2QyMThjND9zPTQ4MCZyPXBnJmQ9aHR0cHMlM0ElMkYlMkZjZG4uYXV0aDAuY29tJTJGYXZhdGFycyUyRmthLnBuZyIsInVwZGF0ZWRfYXQiOiIyMDE5LTA4LTI4VDEwOjE3OjQyLjQ1NFoiLCJlbWFpbCI6ImthbGluLnZlbmtvdkBlbGRlcnNvc3MuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImlzcyI6Imh0dHBzOi8vc3Ryb3dyLWRldmVsb3BtZW50LmV1LmF1dGgwLmNvbS8iLCJzdWIiOiJhdXRoMHw1YzU0NjI1ZDc1ZWIwMjA5NmZkYzM3MzciLCJhdWQiOiJrSVFNNm01dnRQOG0xc2ZwWDdaTTdaYXZLZzJKeTQ1YyIsImlhdCI6MTU2Njk4NzQ2MiwiZXhwIjoxNTY3MDIzNDYyfQ.gNQRp7DhhkmhqCV1QF25i8k4CXCHY8zgjbK-j9YJVuOkniZMbz54V2jR6JCW26wEvd2NkOqINN-mztCao8E2915gjhLjHUeeZBXs9t6VE3_Fs5rd0CfoDLeXlicJAmIb86LZVSZRznOx7NrlEcd9PQP3IdlqYfZiI9blR5GqJRrauDou2NA8qm72Wtth8zoljGl2XSh65bhU0RVF--jYfzP4c3czF4Hvx1iNYDRJENUDJelQVHf_CqJm1_e93Rktm0v0YVUbFrzsJPqL06dHSUO8Q5dZEgql3ArjLq88dcyLPMewbP_6sZhIBHBF6cNndVvi5KrVP_npMf0vu6JhbQ"
        val jwt = JsonWebToken(token)

        val verifier = JWTVerifier()
        val x509 = "MIIDGTCCAgGgAwIBAgIJQ9AWv8SzyokyMA0GCSqGSIb3DQEBCwUAMCoxKDAmBgNVBAMTH3N0cm93ci1kZXZlbG9wbWVudC5ldS5hdXRoMC5jb20wHhcNMTkwMjAxMTUwNDU4WhcNMzIxMDEwMTUwNDU4WjAqMSgwJgYDVQQDEx9zdHJvd3ItZGV2ZWxvcG1lbnQuZXUuYXV0aDAuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0PMn0dVPGCTZvzYl2uuB+UrtA3Cat0p5nsJVEV9YDjp0XH7f75X1l9Mtjynnbq0dhZH3DywwTFHGqcnY9EoMFFY+oo9LjtsO9Kgb+mmLG7QfqA0i2houjc1pK+aFypbiJA56yrPp9K24s2YBGOBNEX3KG4XH3pu8EeRyfpD8OyXP1zmRE21AhL26sHV7GmXNgWE1vtxarxjai8kisxKje7B81COqQcfExxAmXCG3unETz8szEceSRfNHB35mc5VKq8mgIjmZDGTsrcReRclwpJVUinKu1bEjyv4C3ekebTZCQgXqAUbCSMWffNCbj1xht/IimZGyGSSHEW/muy2L+QIDAQABo0IwQDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBShlanHoOK8MgtWwNxdWo3ee7UVdjAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADggEBAKd4FG4Dxt3rc+YbAuu1QK1vNISUO0sk2pp+e9MtKiL5V+SgNwMZz+izA4XnR40y7TwGOS0ldclP+fcVM4NkIMabIGzC+0kWc9DRZHiBazlN6nBx2Ylh9lk85p7w4Sj0Eldv+sSYM0mTJWIdW1/kudLXIROTOU6K6ssFfTdVcwrmYdWvPnmSg5VHlCh81ayApbVJrYUBJ1Tve0iXmIgSkITnnvmHXvR2kwdyJ9tm9HtAqQCWx8pY+UuQuuZDAeB7qXaXK3EwEnBBXKMnNYYt5MEOHnnnEcydDPWFkJqkzC/BxKAALG6QRDF521CCzMwWRzNo9cJM4pKO8RodwfBsdNw="
        verifier.jwksFromX509CertificateChain(x509)

        assert(verifier.verify(jwt))
    }

    @Test
    fun initTestHS256() {
        val token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJuaWNrbmFtZSI6ImthbGluLnZlbmtvdiIsIm5hbWUiOiJrYWxpbi52ZW5rb3ZAZWxkZXJzb3NzLmNvbSIsInBpY3R1cmUiOiJodHRwczovL3MuZ3JhdmF0YXIuY29tL2F2YXRhci9iZTI5OWMwODBlNzEwMDY0MWIwY2FhYmMzM2QyMThjND9zPTQ4MCZyPXBnJmQ9aHR0cHMlM0ElMkYlMkZjZG4uYXV0aDAuY29tJTJGYXZhdGFycyUyRmthLnBuZyIsInVwZGF0ZWRfYXQiOiIyMDE5LTA4LTI4VDEwOjEyOjQyLjE4MloiLCJlbWFpbCI6ImthbGluLnZlbmtvdkBlbGRlcnNvc3MuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImlzcyI6Imh0dHBzOi8vc3Ryb3dyLWRldmVsb3BtZW50LmV1LmF1dGgwLmNvbS8iLCJzdWIiOiJhdXRoMHw1YzU0NjI1ZDc1ZWIwMjA5NmZkYzM3MzciLCJhdWQiOiJrRkI0NjdLejg4N1lOSmNRT0dHc3pqY2tETTNHWURsOSIsImlhdCI6MTU2Njk4NzE2MiwiZXhwIjoxNTY3MDIzMTYyfQ.s0umfzcBjER97QusZ18KSptbhzXEtcs0mONC9cD2sXo"
        val jwt = JsonWebToken(token)

        val verifier = JWTVerifier()
        verifier.clientSecret = "C&F)J@NcRfUjXn2r5u8x/A%D*G-KaPdS"

        assert(verifier.verify(jwt))
    }
}
